<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: layout(~{::head}, ~{::contenido})}">
<head>
    <title>Mapa de Regata</title>
    <style>
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 25px;
            padding: 10px 25px;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .map-container {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }
        
        .map-grid {
            display: grid;
            gap: 1px;
            background-color: #dee2e6;
            border: 2px solid #6c757d;
            border-radius: 8px;
            padding: 5px;
            margin: 0 auto;
            max-width: 100%;
            overflow: auto;
        }
        
        .map-cell {
            width: 30px;
            height: 30px;
            border: 1px solid #adb5bd;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }
        
        .map-cell:hover {
            transform: scale(1.1);
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        .cell-agua {
            background-color: #007bff;
            color: white;
        }
        
        .cell-pared {
            background-color: #6c757d;
            color: white;
        }
        
        .cell-inicio {
            background-color: #28a745;
            color: white;
        }
        
        .cell-fin {
            background-color: #dc3545;
            color: white;
        }
        
        .cell-with-boat {
            position: relative;
        }
        
        .boat-indicator {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            border: 1px solid white;
            z-index: 5;
        }
        
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 20px 0;
            padding: 15px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border: 1px solid #dee2e6;
            border-radius: 3px;
        }
        
        .map-controls {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            justify-content: center;
        }
        
        .zoom-btn {
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .zoom-btn:hover {
            background: #5a6268;
            transform: scale(1.1);
        }
        
        .fullscreen-btn {
            background: #17a2b8;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 8px 15px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .fullscreen-btn:hover {
            background: #138496;
        }
        
        .tooltip-custom {
            position: absolute;
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
            max-width: 200px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
    </style>
    <script th:inline="javascript">
        // Variables globales
        let mapData = {};
        let currentZoom = 1;
        const minZoom = 0.5;
        const maxZoom = 3;
        const zoomStep = 0.2;
        
        // Inicializar datos cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', function() {
            // Datos del servidor
            mapData = {
                gridSize: /*[[${gridSize}]]*/ 10,
                gridRows: /*[[${gridRows}]]*/ 10,
                celdas: /*[[${celdas}]]*/ [],
                barcos: /*[[${barcos}]]*/ []
            };
            
            generateMap();
            
            // Agregar event listener para cerrar modal con Escape
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeModal();
                }
            });
            
            // Agregar event listener para cerrar modal al hacer clic en el backdrop
            document.addEventListener('click', function(e) {
                if (e.target.id === 'modal-backdrop-custom') {
                    closeModal();
                }
            });
        });

        // Generar el mapa
        function generateMap() {
            const mapGrid = document.getElementById('mapGrid');
            mapGrid.style.gridTemplateColumns = `repeat(${mapData.gridSize}, 1fr)`;
            mapGrid.innerHTML = '';

            // Crear matriz de celdas
            const cellMatrix = createCellMatrix();
            
            // Crear matriz de barcos
            const boatMatrix = createBoatMatrix();

            // Generar celdas
            for (let row = 0; row < mapData.gridRows; row++) {
                for (let col = 0; col < mapData.gridSize; col++) {
                    const cell = document.createElement('div');
                    cell.className = 'map-cell';
                    cell.dataset.row = row;
                    cell.dataset.col = col;

                    // Obtener información de la celda
                    const cellInfo = cellMatrix[row] && cellMatrix[row][col];
                    const boatInfo = boatMatrix[row] && boatMatrix[row][col];

                    // Aplicar estilo según el tipo de celda
                    if (cellInfo) {
                        switch (cellInfo.tipo.toLowerCase()) {
                            case 'agua':
                                cell.classList.add('cell-agua');
                                cell.innerHTML = '<i class="fas fa-water"></i>';
                                break;
                            case 'pared':
                                cell.classList.add('cell-pared');
                                cell.innerHTML = '<i class="fas fa-square"></i>';
                                break;
                            case 'inicio':
                                cell.classList.add('cell-inicio');
                                cell.innerHTML = '<i class="fas fa-flag"></i>';
                                break;
                            case 'fin':
                                cell.classList.add('cell-fin');
                                cell.innerHTML = '<i class="fas fa-flag-checkered"></i>';
                                break;
                            default:
                                cell.classList.add('cell-agua');
                                break;
                        }
                    } else {
                        // Celda por defecto (agua)
                        cell.classList.add('cell-agua');
                        cell.innerHTML = '<i class="fas fa-water"></i>';
                    }

                    // Agregar barco si existe
                    if (boatInfo) {
                        cell.classList.add('cell-with-boat');
                        const boatIndicator = document.createElement('div');
                        boatIndicator.className = 'boat-indicator';
                        boatIndicator.style.backgroundColor = boatInfo.modeloColor || '#ffc107';
                        cell.appendChild(boatIndicator);
                    }

                    // Eventos del mouse para tooltip
                    cell.addEventListener('mouseenter', (e) => showTooltip(e, cellInfo, boatInfo));
                    cell.addEventListener('mouseleave', hideTooltip);
                    cell.addEventListener('mousemove', moveTooltip);
                    
                    // Evento de clic para mostrar información detallada
                    cell.addEventListener('click', (e) => showCellDetails(e, cellInfo, boatInfo));

                    mapGrid.appendChild(cell);
                }
            }
        }

        // Crear matriz de celdas
        function createCellMatrix() {
            const matrix = [];
            for (let row = 0; row < mapData.gridRows; row++) {
                matrix[row] = [];
            }

            mapData.celdas.forEach(celda => {
                if (celda.coordY < mapData.gridRows && celda.coordX < mapData.gridSize) {
                    matrix[celda.coordY][celda.coordX] = celda;
                }
            });

            return matrix;
        }

        // Crear matriz de barcos
        function createBoatMatrix() {
            const matrix = [];
            for (let row = 0; row < mapData.gridRows; row++) {
                matrix[row] = [];
            }

            mapData.barcos.forEach(barco => {
                if (barco.posY < mapData.gridRows && barco.posX < mapData.gridSize) {
                    matrix[barco.posY][barco.posX] = barco;
                }
            });

            return matrix;
        }

        // Mostrar tooltip
        function showTooltip(event, cellInfo, boatInfo) {
            const tooltip = document.getElementById('customTooltip');
            let content = '';

            if (cellInfo) {
                content += `<strong>Celda (${cellInfo.coordX}, ${cellInfo.coordY})</strong><br>`;
                content += `Tipo: ${cellInfo.tipo}<br>`;
                content += `ID: ${cellInfo.id}`;
            } else {
                content += `<strong>Celda (${event.target.dataset.col}, ${event.target.dataset.row})</strong><br>`;
                content += `Tipo: Agua`;
            }

            if (boatInfo) {
                content += `<br><br><strong>Barco</strong><br>`;
                content += `Jugador: ${boatInfo.jugadorNombre}<br>`;
                content += `Modelo: ${boatInfo.modeloNombre}<br>`;
                content += `Velocidad: (${boatInfo.velX}, ${boatInfo.velY})`;
            }

            tooltip.innerHTML = content;
            tooltip.style.display = 'block';
            moveTooltip(event);
        }

        // Ocultar tooltip
        function hideTooltip() {
            const tooltip = document.getElementById('customTooltip');
            tooltip.style.display = 'none';
        }

        // Mover tooltip
        function moveTooltip(event) {
            const tooltip = document.getElementById('customTooltip');
            tooltip.style.left = (event.pageX + 10) + 'px';
            tooltip.style.top = (event.pageY - 10) + 'px';
        }

        // Mostrar detalles de la celda al hacer clic
        function showCellDetails(event, cellInfo, boatInfo) {
            console.log('Clic detectado en celda:', event.target.dataset.col, event.target.dataset.row);
            
            const modal = document.getElementById('cellDetailsModal');
            const modalBody = document.getElementById('cellDetailsBody');
            
            if (!modal || !modalBody) {
                console.error('Modal o modalBody no encontrado');
                return;
            }
            
            let content = '';
            
            // Información de la celda
            if (cellInfo) {
                content += `<div class="mb-3">`;
                content += `<h6><i class="fas fa-map-marker-alt me-2"></i>Información de la Celda</h6>`;
                content += `<p><strong>Coordenadas:</strong> (${cellInfo.coordX}, ${cellInfo.coordY})</p>`;
                content += `<p><strong>Tipo:</strong> <span class="badge bg-info">${cellInfo.tipo}</span></p>`;
                content += `<p><strong>ID:</strong> ${cellInfo.id}</p>`;
                content += `</div>`;
            } else {
                content += `<div class="mb-3">`;
                content += `<h6><i class="fas fa-map-marker-alt me-2"></i>Información de la Celda</h6>`;
                content += `<p><strong>Coordenadas:</strong> (${event.target.dataset.col}, ${event.target.dataset.row})</p>`;
                content += `<p><strong>Tipo:</strong> <span class="badge bg-info">Agua</span></p>`;
                content += `<p><strong>Estado:</strong> Celda por defecto</p>`;
                content += `</div>`;
            }
            
            // Información del barco si existe
            if (boatInfo) {
                content += `<div class="mb-3">`;
                content += `<h6><i class="fas fa-ship me-2"></i>Barco en esta posición</h6>`;
                content += `<p><strong>Jugador:</strong> ${boatInfo.jugadorNombre}</p>`;
                content += `<p><strong>Modelo:</strong> ${boatInfo.modeloNombre}</p>`;
                content += `<p><strong>Posición:</strong> (${boatInfo.posX}, ${boatInfo.posY})</p>`;
                content += `<p><strong>Velocidad:</strong> (${boatInfo.velX}, ${boatInfo.velY})</p>`;
                if (boatInfo.modeloColor) {
                    content += `<p><strong>Color:</strong> <span class="badge" style="background-color: ${boatInfo.modeloColor}; color: white;">${boatInfo.modeloColor}</span></p>`;
                }
                content += `</div>`;
            } else {
                content += `<div class="mb-3">`;
                content += `<h6><i class="fas fa-ship me-2"></i>Información del Barco</h6>`;
                content += `<p class="text-muted">No hay barcos en esta posición</p>`;
                content += `</div>`;
            }
            
            modalBody.innerHTML = content;
            
            console.log('Contenido del modal generado:', content);
            
            // Verificar si Bootstrap está disponible
            if (typeof bootstrap === 'undefined') {
                console.error('Bootstrap no está disponible');
                // Fallback: mostrar modal manualmente
                modal.style.display = 'block';
                modal.classList.add('show');
                document.body.classList.add('modal-open');
                
                // Crear backdrop
                const backdrop = document.createElement('div');
                backdrop.className = 'modal-backdrop fade show';
                backdrop.id = 'modal-backdrop-custom';
                document.body.appendChild(backdrop);
                
                return;
            }
            
            // Mostrar el modal usando Bootstrap
            try {
                const bsModal = new bootstrap.Modal(modal);
                bsModal.show();
                console.log('Modal mostrado con Bootstrap');
            } catch (error) {
                console.error('Error al mostrar modal con Bootstrap:', error);
                // Fallback manual
                modal.style.display = 'block';
                modal.classList.add('show');
                document.body.classList.add('modal-open');
            }
        }

        // Controles de zoom
        function zoomIn() {
            if (currentZoom < maxZoom) {
                currentZoom += zoomStep;
                applyZoom();
            }
        }

        function zoomOut() {
            if (currentZoom > minZoom) {
                currentZoom -= zoomStep;
                applyZoom();
            }
        }

        function applyZoom() {
            const mapGrid = document.getElementById('mapGrid');
            mapGrid.style.transform = `scale(${currentZoom})`;
            mapGrid.style.transformOrigin = 'center';
        }

        // Pantalla completa
        function toggleFullscreen() {
            const mapContainer = document.querySelector('.map-container');
            if (!document.fullscreenElement) {
                mapContainer.requestFullscreen().catch(err => {
                    console.log('Error al entrar en pantalla completa:', err);
                });
            } else {
                document.exitFullscreen();
            }
        }

        // Función para cerrar modal manualmente
        function closeModal() {
            const modal = document.getElementById('cellDetailsModal');
            if (modal) {
                modal.style.display = 'none';
                modal.classList.remove('show');
                document.body.classList.remove('modal-open');
                
                // Remover backdrop si existe
                const backdrop = document.querySelector('.modal-backdrop');
                if (backdrop) {
                    backdrop.remove();
                }
            }
        }
        

    </script>
</head>
<body>
    <div th:fragment="contenido" class="container mt-4">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h3 class="card-title mb-0">
                            <i class="fas fa-map me-2"></i>Mapa de Regata
                        </h3>
                    </div>
                    <div class="card-body">
                        <!-- Estadísticas -->
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-number" th:text="${gridSize}">10</div>
                                <div class="stat-label">Tamaño de Grilla</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" th:text="${totalCeldas}">100</div>
                                <div class="stat-label">Total Celdas</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" th:text="${totalBarcos}">0</div>
                                <div class="stat-label">Barcos en Mapa</div>
                            </div>
                        </div>

                        <!-- Leyenda -->
                        <div class="legend">
                            <div class="legend-item">
                                <div class="legend-color cell-agua"></div>
                                <span>Agua</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color cell-pared"></div>
                                <span>Pared</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color cell-inicio"></div>
                                <span>Inicio</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color cell-fin"></div>
                                <span>Fin</span>
                            </div>
                            <div class="legend-item">
                                <div class="boat-indicator" style="position: static; width: 20px; height: 20px; background: #ffc107;"></div>
                                <span>Barco</span>
                            </div>
                        </div>

                        <!-- Controles del mapa -->
                        <div class="map-controls">
                            <button class="zoom-btn" onclick="zoomIn()" title="Acercar">
                                <i class="fas fa-plus"></i>
                            </button>
                            <button class="zoom-btn" onclick="zoomOut()" title="Alejar">
                                <i class="fas fa-minus"></i>
                            </button>
                            <button class="fullscreen-btn" onclick="toggleFullscreen()" title="Pantalla completa">
                                <i class="fas fa-expand"></i> Pantalla completa
                            </button>
                        </div>

                        <!-- Contenedor del mapa -->
                        <div class="map-container">
                            <div id="mapGrid" class="map-grid"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tooltip personalizado -->
    <div id="customTooltip" class="tooltip-custom" style="display: none;"></div>
</body>

<!-- Modal para detalles de celda - Fuera del fragmento contenido -->
<div class="modal fade" id="cellDetailsModal" tabindex="-1" aria-labelledby="cellDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="cellDetailsModalLabel">
                    <i class="fas fa-info-circle me-2"></i>Detalles del Espacio
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close" onclick="closeModal()"></button>
            </div>
            <div class="modal-body" id="cellDetailsBody">
                <!-- El contenido se genera dinámicamente -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="closeModal()">
                    <i class="fas fa-times me-2"></i>Cerrar
                </button>
            </div>
        </div>
    </div>
</div>
</html>