<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${celda.id != null ? 'Editar Celda' : 'Nueva Celda'} + ' - Regata Online'">Celda - Regata Online</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .form-control:focus {
            border-color: #0d6efd;
            box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
        }
        .card {
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }
        .cell-preview {
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            margin: 0 auto;
            transition: all 0.3s ease;
        }
        .cell-agua { background-color: #cce7ff; color: #0066cc; border-color: #0066cc; }
        .cell-pared { background-color: #6c757d; color: white; border-color: #495057; }
        .cell-partida { background-color: #28a745; color: white; border-color: #1e7e34; }
        .cell-meta { background-color: #dc3545; color: white; border-color: #c82333; }
        .coordinate-input {
            text-align: center;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-anchor me-2"></i>Regata Online
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/">Inicio</a>
                <a class="nav-link" href="/jugadores">Jugadores</a>
                <a class="nav-link" href="/barcos">Barcos</a>
                <a class="nav-link" href="/modelos">Modelos</a>
                <a class="nav-link" href="/partidas">Partidas</a>
                <a class="nav-link" href="/mapas">Mapas</a>
                <a class="nav-link active" href="/celdas">Celdas</a>
            </div>
        </div>
    </nav>

    <main class="container mt-4">
        <div class="row justify-content-center">
            <div class="col-md-8 col-lg-6">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h4 class="card-title mb-0">
                            <i class="fas fa-th me-2"></i>
                            <span th:text="${celda.id != null ? 'Editar Celda' : 'Nueva Celda'}">Nueva Celda</span>
                        </h4>
                    </div>
                    <div class="card-body">
                        <!-- Mensajes de error -->
                        <div th:if="${errorMessage}" class="alert alert-danger" role="alert">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            <span th:text="${errorMessage}"></span>
                        </div>

                        <form th:action="${celda.id != null ? '/celdas/' + celda.id : '/celdas'}" 
                              th:object="${celda}" method="post">
                            
                            <!-- Mapa -->
                            <div class="mb-3">
                                <label for="mapa" class="form-label">
                                    <i class="fas fa-map me-1"></i>Mapa
                                    <span class="text-danger">*</span>
                                </label>
                                <select class="form-select" 
                                        th:class="${#fields.hasErrors('mapa')} ? 'form-select is-invalid' : 'form-select'"
                                        id="mapa" 
                                        th:field="*{mapa}" 
                                        required
                                        onchange="updateMapInfo()">
                                    <option value="">Seleccione un mapa</option>
                                    <option th:each="mapaOption : ${mapas}" 
                                            th:value="${mapaOption.id}" 
                                            th:text="${mapaOption.nombre + ' (' + mapaOption.tamFilas + 'x' + mapaOption.tamColumnas + ')'}"
                                            th:data-filas="${mapaOption.tamFilas}"
                                            th:data-columnas="${mapaOption.tamColumnas}">Mapa</option>
                                </select>
                                <div class="form-text">
                                    Seleccione el mapa al que pertenecerá esta celda
                                </div>
                                <div th:if="${#fields.hasErrors('mapa')}" class="invalid-feedback">
                                    <span th:errors="*{mapa}"></span>
                                </div>
                            </div>

                            <!-- Información del mapa seleccionado -->
                            <div id="mapInfo" class="mb-3" style="display: none;">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>Dimensiones del mapa:</strong> 
                                    <span id="mapDimensions">-</span>
                                    <br>
                                    <strong>Coordenadas válidas:</strong> 
                                    X: 0 a <span id="maxX">-</span>, Y: 0 a <span id="maxY">-</span>
                                </div>
                            </div>

                            <!-- Coordenadas -->
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="x" class="form-label">
                                            <i class="fas fa-arrows-alt-h me-1"></i>Coordenada X
                                            <span class="text-danger">*</span>
                                        </label>
                                        <input type="number" 
                                               class="form-control coordinate-input" 
                                               th:class="${#fields.hasErrors('x')} ? 'form-control coordinate-input is-invalid' : 'form-control coordinate-input'"
                                               id="x" 
                                               th:field="*{x}" 
                                               min="0" 
                                               placeholder="0"
                                               required
                                               onchange="updatePreview()">
                                        <div class="form-text">
                                            Posición horizontal (columna)
                                        </div>
                                        <div th:if="${#fields.hasErrors('x')}" class="invalid-feedback">
                                            <span th:errors="*{x}"></span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="y" class="form-label">
                                            <i class="fas fa-arrows-alt-v me-1"></i>Coordenada Y
                                            <span class="text-danger">*</span>
                                        </label>
                                        <input type="number" 
                                               class="form-control coordinate-input" 
                                               th:class="${#fields.hasErrors('y')} ? 'form-control coordinate-input is-invalid' : 'form-control coordinate-input'"
                                               id="y" 
                                               th:field="*{y}" 
                                               min="0" 
                                               placeholder="0"
                                               required
                                               onchange="updatePreview()">
                                        <div class="form-text">
                                            Posición vertical (fila)
                                        </div>
                                        <div th:if="${#fields.hasErrors('y')}" class="invalid-feedback">
                                            <span th:errors="*{y}"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Tipo de Celda -->
                            <div class="mb-3">
                                <label for="tipo" class="form-label">
                                    <i class="fas fa-tag me-1"></i>Tipo de Celda
                                    <span class="text-danger">*</span>
                                </label>
                                <select class="form-select" 
                                        th:class="${#fields.hasErrors('tipo')} ? 'form-select is-invalid' : 'form-select'"
                                        id="tipo" 
                                        th:field="*{tipo}" 
                                        required
                                        onchange="updatePreview()">
                                    <option value="">Seleccione un tipo</option>
                                    <option th:each="tipoEnum : ${tipos}" 
                                            th:value="${tipoEnum.name()}" 
                                            th:text="${tipoEnum.name()}">Tipo</option>
                                </select>
                                <div class="form-text">
                                    Defina el comportamiento de esta celda en el juego
                                </div>
                                <div th:if="${#fields.hasErrors('tipo')}" class="invalid-feedback">
                                    <span th:errors="*{tipo}"></span>
                                </div>
                            </div>

                            <!-- Vista previa de la celda -->
                            <div class="mb-4">
                                <label class="form-label">
                                    <i class="fas fa-eye me-1"></i>Vista Previa
                                </label>
                                <div class="text-center p-4 bg-light rounded">
                                    <div id="cellPreview" class="cell-preview">
                                        ?
                                    </div>
                                    <div class="mt-3">
                                        <small class="text-muted">
                                            Posición: (<span id="previewX">-</span>, <span id="previewY">-</span>)
                                            <br>
                                            Tipo: <span id="previewType">-</span>
                                        </small>
                                    </div>
                                </div>
                            </div>

                            <!-- Información sobre tipos de celda -->
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Tipos de Celda:</strong>
                                <ul class="mb-0 mt-2">
                                    <li><strong>AGUA:</strong> Celda navegable por los barcos</li>
                                    <li><strong>PARED:</strong> Obstáculo que bloquea el movimiento</li>
                                    <li><strong>PARTIDA:</strong> Punto de inicio de la regata</li>
                                    <li><strong>META:</strong> Objetivo final de la regata</li>
                                </ul>
                            </div>

                            <!-- Botones de acción -->
                            <div class="d-flex justify-content-between">
                                <a href="/celdas" class="btn btn-outline-secondary">
                                    <i class="fas fa-arrow-left me-1"></i>
                                    Cancelar
                                </a>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-1"></i>
                                    <span th:text="${celda.id != null ? 'Actualizar Celda' : 'Crear Celda'}">Crear Celda</span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function updateMapInfo() {
            const mapaSelect = document.getElementById('mapa');
            const selectedOption = mapaSelect.options[mapaSelect.selectedIndex];
            const mapInfo = document.getElementById('mapInfo');
            const mapDimensions = document.getElementById('mapDimensions');
            const maxX = document.getElementById('maxX');
            const maxY = document.getElementById('maxY');
            const xInput = document.getElementById('x');
            const yInput = document.getElementById('y');
            
            if (selectedOption.value) {
                const filas = selectedOption.getAttribute('data-filas');
                const columnas = selectedOption.getAttribute('data-columnas');
                
                mapDimensions.textContent = filas + ' x ' + columnas;
                maxX.textContent = (columnas - 1);
                maxY.textContent = (filas - 1);
                
                xInput.max = columnas - 1;
                yInput.max = filas - 1;
                
                mapInfo.style.display = 'block';
            } else {
                mapInfo.style.display = 'none';
                xInput.removeAttribute('max');
                yInput.removeAttribute('max');
            }
            
            updatePreview();
        }
        
        function updatePreview() {
            const x = document.getElementById('x').value;
            const y = document.getElementById('y').value;
            const tipo = document.getElementById('tipo').value;
            const preview = document.getElementById('cellPreview');
            const previewX = document.getElementById('previewX');
            const previewY = document.getElementById('previewY');
            const previewType = document.getElementById('previewType');
            
            // Actualizar coordenadas
            previewX.textContent = x || '-';
            previewY.textContent = y || '-';
            previewType.textContent = tipo || '-';
            
            // Limpiar clases anteriores
            preview.className = 'cell-preview';
            
            // Aplicar estilo según el tipo
            if (tipo) {
                switch(tipo) {
                    case 'AGUA':
                        preview.classList.add('cell-agua');
                        preview.textContent = '~';
                        break;
                    case 'PARED':
                        preview.classList.add('cell-pared');
                        preview.textContent = '█';
                        break;
                    case 'PARTIDA':
                        preview.classList.add('cell-partida');
                        preview.textContent = 'S';
                        break;
                    case 'META':
                        preview.classList.add('cell-meta');
                        preview.textContent = 'F';
                        break;
                    default:
                        preview.textContent = '?';
                }
            } else {
                preview.textContent = '?';
            }
        }
        
        // Inicializar al cargar la página
        document.addEventListener('DOMContentLoaded', function() {
            updateMapInfo();
            updatePreview();
        });
    </script>
</body>
</html>