<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Regata Online - Tablero de Juego</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .tablero {
            display: grid;
            gap: 1px;
            background-color: #333;
            border: 2px solid #333;
            margin: 20px auto;
            max-width: 800px;
        }
        
        .celda {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            position: relative;
        }
        
        .celda-agua { background-color: #87CEEB; }
        .celda-pared { background-color: #8B4513; }
        .celda-partida { background-color: #90EE90; }
        .celda-meta { background-color: #FFD700; }
        
        .barco {
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid #000;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: white;
            z-index: 10;
        }
        
        .mi-barco {
            border-color: #ff0000;
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
        }
        
        .controles {
            max-width: 400px;
            margin: 20px auto;
        }
        
        .btn-movimiento {
            width: 60px;
            height: 60px;
            margin: 2px;
        }
        
        .info-barco {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
        }
        
        .estado-destruido { background-color: #dc3545; }
        .estado-llego { background-color: #28a745; }
        .estado-vivo { background-color: #007bff; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/regata">
                <i class="fas fa-ship"></i> Regata Online
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/juego">Volver a Partidas</a>
                <a class="nav-link" href="/juego/ayuda">Ayuda</a>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <!-- Panel de información -->
            <div class="col-md-3">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-info-circle"></i> Información de la Partida</h5>
                    </div>
                    <div class="card-body">
                        <p><strong>Partida:</strong> <span th:text="${partida.nombre}"></span></p>
                        <p><strong>Estado:</strong> 
                            <span class="badge" 
                                  th:classappend="${partida.estado.name() == 'EN_CURSO'} ? 'bg-success' : 'bg-secondary'"
                                  th:text="${partida.estado}"></span>
                        </p>
                        <p><strong>Mapa:</strong> <span th:text="${mapa.nombre}"></span></p>
                        <p><strong>Dimensiones:</strong> <span th:text="${mapa.ancho} + 'x' + ${mapa.alto}"></span></p>
                    </div>
                </div>
                
                <!-- Información del barco del jugador -->
                <div class="card mt-3" th:if="${miParticipacion != null}">
                    <div class="card-header">
                        <h5><i class="fas fa-ship"></i> Mi Barco</h5>
                    </div>
                    <div class="card-body">
                        <div class="info-barco">
                            <p><strong>Modelo:</strong> <span th:text="${miParticipacion.barco.modelo.nombre}"></span></p>
                            <p><strong>Posición:</strong> 
                                (<span th:text="${miParticipacion.posX}"></span>, 
                                 <span th:text="${miParticipacion.posY}"></span>)
                            </p>
                            <p><strong>Velocidad:</strong> 
                                (<span id="velocidadX" th:text="${miParticipacion.barco.velocidadX}"></span>, 
                                 <span id="velocidadY" th:text="${miParticipacion.barco.velocidadY}"></span>)
                            </p>
                            <p><strong>Estado:</strong> 
                                <span id="estadoBarco" class="badge" 
                                      th:classappend="'estado-' + ${miParticipacion.barco.estado.name().toLowerCase()}"
                                      th:text="${miParticipacion.barco.estado}"></span>
                            </p>
                        </div>
                    </div>
                </div>
                
                <!-- Controles de movimiento -->
                <div class="card mt-3" th:if="${miParticipacion != null and miParticipacion.barco.estado.name() == 'VIVO'}">
                    <div class="card-header">
                        <h5><i class="fas fa-gamepad"></i> Controles</h5>
                    </div>
                    <div class="card-body">
                        <div class="controles text-center">
                            <p><strong>Cambiar Velocidad:</strong></p>
                            <div class="row">
                                <div class="col-4">
                                    <button class="btn btn-outline-primary btn-movimiento" 
                                            onclick="moverBarco(-1, 1)" title="↖ (-1, +1)">
                                        <i class="fas fa-arrow-up" style="transform: rotate(-45deg);"></i>
                                    </button>
                                </div>
                                <div class="col-4">
                                    <button class="btn btn-outline-primary btn-movimiento" 
                                            onclick="moverBarco(0, 1)" title="↑ (0, +1)">
                                        <i class="fas fa-arrow-up"></i>
                                    </button>
                                </div>
                                <div class="col-4">
                                    <button class="btn btn-outline-primary btn-movimiento" 
                                            onclick="moverBarco(1, 1)" title="↗ (+1, +1)">
                                        <i class="fas fa-arrow-up" style="transform: rotate(45deg);"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-4">
                                    <button class="btn btn-outline-primary btn-movimiento" 
                                            onclick="moverBarco(-1, 0)" title="← (-1, 0)">
                                        <i class="fas fa-arrow-left"></i>
                                    </button>
                                </div>
                                <div class="col-4">
                                    <button class="btn btn-warning btn-movimiento" 
                                            onclick="moverBarco(0, 0)" title="Mantener (0, 0)">
                                        <i class="fas fa-pause"></i>
                                    </button>
                                </div>
                                <div class="col-4">
                                    <button class="btn btn-outline-primary btn-movimiento" 
                                            onclick="moverBarco(1, 0)" title="→ (+1, 0)">
                                        <i class="fas fa-arrow-right"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-4">
                                    <button class="btn btn-outline-primary btn-movimiento" 
                                            onclick="moverBarco(-1, -1)" title="↙ (-1, -1)">
                                        <i class="fas fa-arrow-down" style="transform: rotate(45deg);"></i>
                                    </button>
                                </div>
                                <div class="col-4">
                                    <button class="btn btn-outline-primary btn-movimiento" 
                                            onclick="moverBarco(0, -1)" title="↓ (0, -1)">
                                        <i class="fas fa-arrow-down"></i>
                                    </button>
                                </div>
                                <div class="col-4">
                                    <button class="btn btn-outline-primary btn-movimiento" 
                                            onclick="moverBarco(1, -1)" title="↘ (+1, -1)">
                                        <i class="fas fa-arrow-down" style="transform: rotate(-45deg);"></i>
                                    </button>
                                </div>
                            </div>
                            <small class="text-muted mt-2 d-block">
                                Los números indican el cambio en velocidad (vx, vy)
                            </small>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Tablero de juego -->
            <div class="col-md-9">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-map"></i> Tablero de Juego</h5>
                        <button class="btn btn-sm btn-outline-primary float-end" onclick="actualizarTablero()">
                            <i class="fas fa-sync-alt"></i> Actualizar
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="tablero" 
                             th:style="'grid-template-columns: repeat(' + ${mapa.ancho} + ', 30px);'">
                            
                            <!-- Generar celdas del mapa -->
                            <div th:each="y : ${#numbers.sequence(mapa.alto - 1, 0, -1)}">
                                <div th:each="x : ${#numbers.sequence(0, mapa.ancho - 1)}" 
                                     class="celda"
                                     th:classappend="${#lists.contains(celdas.?[posX == x and posY == y], true)} ? 
                                                    ('celda-' + ${celdas.?[posX == x and posY == y][0]?.tipo?.name()?.toLowerCase()}) : 
                                                    'celda-agua'"
                                     th:data-x="${x}" 
                                     th:data-y="${y}">
                                    
                                    <!-- Mostrar símbolo de la celda -->
                                    <span th:if="${#lists.contains(celdas.?[posX == x and posY == y], true)}" 
                                          th:switch="${celdas.?[posX == x and posY == y][0]?.tipo?.name()}">
                                        <span th:case="'PARED'">X</span>
                                        <span th:case="'PARTIDA'">P</span>
                                        <span th:case="'META'">M</span>
                                    </span>
                                    
                                    <!-- Mostrar barcos en esta posición -->
                                    <div th:each="participacion : ${participaciones}" 
                                         th:if="${participacion.posX == x and participacion.posY == y}">
                                        <div class="barco" 
                                             th:classappend="${miParticipacion != null and participacion.barco.id == miParticipacion.barco.id} ? 'mi-barco' : ''"
                                             th:style="'background-color: ' + ${participacion.barco.modelo.color} + ';'"
                                             th:title="'Jugador: ' + ${participacion.jugador.nombre} + ' - Barco: ' + ${participacion.barco.modelo.nombre}">
                                            <span th:text="${participacion.jugador.nombre.substring(0, 1).toUpperCase()}"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Leyenda -->
                        <div class="mt-3">
                            <h6>Leyenda:</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <span class="celda celda-agua d-inline-block me-2"></span> Agua
                                    <span class="celda celda-pared d-inline-block me-2 ms-3">X</span> Pared
                                </div>
                                <div class="col-md-6">
                                    <span class="celda celda-partida d-inline-block me-2">P</span> Partida
                                    <span class="celda celda-meta d-inline-block me-2 ms-3">M</span> Meta
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const miBarcoId = /*[[${miParticipacion?.barco?.id}]]*/ null;
        const partidaId = /*[[${partida.id}]]*/ null;
        
        function moverBarco(cambioVx, cambioVy) {
            if (!miBarcoId) {
                alert('No tienes un barco en esta partida');
                return;
            }
            
            // Deshabilitar botones temporalmente
            const botones = document.querySelectorAll('.btn-movimiento');
            botones.forEach(btn => btn.disabled = true);
            
            fetch('/regata/juego/mover', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `barcoId=${miBarcoId}&cambioVx=${cambioVx}&cambioVy=${cambioVy}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Actualizar información del barco
                    if (data.velocidadX !== undefined) {
                        document.getElementById('velocidadX').textContent = data.velocidadX;
                    }
                    if (data.velocidadY !== undefined) {
                        document.getElementById('velocidadY').textContent = data.velocidadY;
                    }
                    if (data.estado !== undefined) {
                        const estadoElement = document.getElementById('estadoBarco');
                        estadoElement.textContent = data.estado;
                        estadoElement.className = 'badge estado-' + data.estado.toLowerCase();
                    }
                    
                    // Actualizar tablero
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error de conexión');
            })
            .finally(() => {
                // Rehabilitar botones
                botones.forEach(btn => btn.disabled = false);
            });
        }
        
        function actualizarTablero() {
            location.reload();
        }
        
        // Actualizar automáticamente cada 5 segundos
        setInterval(actualizarTablero, 5000);
    </script>
</body>
</html>